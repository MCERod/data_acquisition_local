flowchart TD
    A["ğŸš€ SYSTEM START"] --> B["âš™ï¸ Initialize Serial & I2C"]
    B --> C["ğŸ” Scan I2C Bus"]
    C --> D["ğŸ“¦ Create Queues & Semaphores"]
    D --> E["ğŸ”„ Create FreeRTOS Tasks"]
    E --> F["âŒ Delete Main Loop Task"]
    
    %% Task Creation - Simplified with more spacing
    E --> G1["ğŸ“ GPS TASK<br/>Priority: 2"]
    E --> G2["ğŸ“Š IMU TASK<br/>Priority: 3"] 
    E --> G3["ğŸ“ LIDAR TASK<br/>Priority: 3"]
    E --> G4["ğŸ’¾ SD CARD TASK<br/>Priority: 2"]
    E --> G5["ğŸŒ TCP SERVER<br/>Priority: 1"]
    
    %% Add spacing between task flows
    G1 -.-> SPACE1[" "]
    G2 -.-> SPACE2[" "]
    G3 -.-> SPACE3[" "]
    G4 -.-> SPACE4[" "]
    G5 -.-> SPACE5[" "]
    
    %% GPS Task Flow - Simplified with spacing
    SPACE1 -.-> GPS1["ğŸ“¡ Init GPS Serial"]
    GPS1 --> GPS2{"ğŸ“¶ Data Available?"}
    GPS2 -->|YES| GPS3["âœ… Parse & Update"]
    GPS2 -->|NO| GPS4["âš ï¸ Check Connection"]
    GPS3 --> GPS5["ğŸ“¤ Send to Queue"]
    GPS4 --> GPS5
    GPS5 --> GPS6["â±ï¸ Delay 100ms"]
    GPS6 --> GPS2
    
    %% IMU Task Flow - Simplified with spacing
    SPACE2 -.-> IMU1["ğŸ”§ Init MPU6050"]
    IMU1 --> IMU2{"ğŸ¯ Connected?"}
    IMU2 -->|YES| IMU3["âš™ï¸ Configure & Calibrate"]
    IMU2 -->|NO| IMU4["âŒ Print Error"]
    IMU3 --> IMU5["ğŸ“ˆ Read Motion Data"]
    IMU4 --> IMU5
    IMU5 --> IMU6["ğŸ”„ Apply Filters"]
    IMU6 --> IMU7["ğŸ“¤ Send to Queue"]
    IMU7 --> IMU8["â±ï¸ Delay 10ms"]
    IMU8 --> IMU5
    
    %% LIDAR Task Flow - Simplified with spacing
    SPACE3 -.-> LDR1["ğŸ”§ Init LIDAR07"]
    LDR1 --> LDR2{"ğŸ¯ Connected?"}
    LDR2 -->|YES| LDR3["âš™ï¸ Configure Mode"]
    LDR2 -->|NO| LDR4["ğŸ”„ Retry Init"]
    LDR3 --> LDR5["ğŸ“ Read Distance"]
    LDR4 --> LDR2
    LDR5 --> LDR6{"ğŸ’ª Signal > 80?"}
    LDR6 -->|YES| LDR7["ğŸ“¤ Send to Queue"]
    LDR6 -->|NO| LDR8["â±ï¸ Delay 100ms"]
    LDR7 --> LDR8
    LDR8 --> LDR5
    
    %% SD Card Task Flow - Simplified with spacing
    SPACE4 -.-> SD1["ğŸ’¾ Init SD Card"]
    SD1 --> SD2{"ğŸ“ SD Ready?"}
    SD2 -->|YES| SD3["ğŸ”„ Main Loop"]
    SD2 -->|NO| SD4["ğŸ”„ Retry Init"]
    SD3 --> SD5{"ğŸ¬ Recording?"}
    SD4 --> SD2
    SD5 -->|START| SD6["ğŸ“ Create File"]
    SD5 -->|STOP| SD7["ğŸ’¾ Close File"]
    SD5 -->|ACTIVE| SD8["ğŸ“Š Read Sensors"]
    SD6 --> SD9["ğŸ“‹ Write Header"]
    SD7 --> SD3
    SD8 --> SD10["ğŸ’¾ Write CSV"]
    SD9 --> SD3
    SD10 --> SD11["ğŸ”„ Flush Check"]
    SD11 --> SD3
    
    %% TCP Server Task Flow - Simplified with spacing
    SPACE5 -.-> TCP1["ğŸ“¶ Setup WiFi AP"]
    TCP1 --> TCP2["ğŸŒ Start TCP Server"]
    TCP2 --> TCP3["ğŸ”„ Main Loop"]
    TCP3 --> TCP4{"ğŸ‘¤ Client Connected?"}
    TCP4 -->|YES| TCP5{"ğŸ“¨ Command?"}
    TCP4 -->|NO| TCP6["â³ Wait Client"]
    TCP5 -->|START| TCP7["ğŸ¬ Start Recording"]
    TCP5 -->|STOP| TCP8["â¹ï¸ Stop Recording"]
    TCP5 -->|EVENT| TCP9["ğŸ“ Log Event"]
    TCP5 -->|NONE| TCP10["ğŸ“Š Send Status"]
    TCP6 --> TCP3
    TCP7 --> TCP11["ğŸ“¤ Send Response"]
    TCP8 --> TCP11
    TCP9 --> TCP11
    TCP10 --> TCP12["â±ï¸ Delay 100ms"]
    TCP11 --> TCP3
    TCP12 --> TCP3
    
    %% Position legend on the right side
    F -.-> RightLegend
    
    %% Right side Legend
    subgraph RightLegend ["ğŸ“‹ LEGEND & SPECS"]
        direction TB
        
        subgraph Legend ["ğŸ“‹ LEGEND"]
            direction TB
            L1["ğŸš€ System Start"] 
            L2["ğŸ“ FreeRTOS Task"]
            L3["ğŸ”„ Process/Action"]
            L4["ğŸ”¶ Decision Point"]
            L5["ğŸ“¤ Queue Operation"]
        end
        
        subgraph TechInfo ["âš™ï¸ TECHNICAL INFO"]
            direction TB
            T1["ğŸ“Š SAMPLING RATES<br/>â€¢ GPS: 1Hz every 1000ms<br/>â€¢ IMU: 100Hz every 10ms<br/>â€¢ LIDAR: 10Hz every 100ms"]
            T2["ğŸ”— COMMUNICATION<br/>â€¢ I2C: MPU6050 + LIDAR07<br/>â€¢ UART: GPS Module<br/>â€¢ WiFi: TCP Server"]
            T3["ğŸ“ DATA FORMAT<br/>â€¢ CSV with timestamps<br/>â€¢ Combined sensor data<br/>â€¢ Event logging support"]
            T4["ğŸŒ NETWORK CONFIG<br/>â€¢ AP: 192.168.20.55<br/>â€¢ Port: 1000<br/>â€¢ Commands: START/STOP/Events"]
        end
    end
    
    %% Improved Style definitions with much larger fonts
    classDef startClass fill:#ff9999,stroke:#cc0000,stroke-width:4px,font-size:18px,font-weight:bold
    classDef taskClass fill:#99ccff,stroke:#0066cc,stroke-width:4px,font-size:16px,font-weight:bold
    classDef actionClass fill:#99ff99,stroke:#00cc00,stroke-width:3px,font-size:14px,font-weight:bold
    classDef decisionClass fill:#ffcc99,stroke:#ff6600,stroke-width:3px,font-size:14px,font-weight:bold
    classDef queueClass fill:#cc99ff,stroke:#6600cc,stroke-width:3px,font-size:14px,font-weight:bold
    classDef legendClass fill:#f0f0f0,stroke:#333333,stroke-width:2px,font-size:13px,font-weight:bold
    classDef techClass fill:#e6f3ff,stroke:#0066cc,stroke-width:2px,font-size:12px,font-weight:bold
    classDef invisibleClass fill:transparent,stroke:transparent
    
    %% Apply styles to make text more visible
    class A startClass
    class G1,G2,G3,G4,G5 taskClass
    class GPS5,IMU7,LDR7,SD10,TCP11 queueClass
    class B,C,D,E,F actionClass
    class GPS2,IMU2,LDR2,LDR6,SD2,SD5,TCP4,TCP5 decisionClass
    class SPACE1,SPACE2,SPACE3,SPACE4,SPACE5 invisibleClass
    
    %% Legend styles
    class L1 startClass
    class L2 taskClass
    class L3 actionClass
    class L4 decisionClass
    class L5 queueClass
    class T1,T2,T3,T4 techClass
